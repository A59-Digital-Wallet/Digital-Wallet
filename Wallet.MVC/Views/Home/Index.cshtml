@model HomeViewModel
@{
    ViewData["Title"] = "Home Page";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 font-sans">

    <div class="container mx-auto mt-8">
        @if (User.Identity.IsAuthenticated)
        {
            <div class="flex flex-wrap">
                <!-- Sidebar -->
                <div class="w-full lg:w-1/4 p-4">
                    <div class="bg-white rounded-xl p-6 shadow-md">
                        <div class="text-center mb-6">
                            <img src="https://via.placeholder.com/150" alt="User Image" class="mx-auto rounded-full mb-3">
                            <h5 class="font-bold text-lg">@User.Identity.Name</h5>
                            <p class="text-gray-600">@User.Identity.Name's Dashboard</p>
                            <a class="text-indigo-600" href="@Url.Action("Profile", "User")">Profile</a>
                        </div>

                        <div class="text-center mt-4">
                            <p>You have USD 1,000 pending money. It will be ready in 2 business days.</p>
                            <button class="bg-indigo-600 text-white rounded-full font-bold py-2 px-4 w-full">Get your money now</button>
                        </div>

                        <!-- Cards Section -->
                        <div class="mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-bold text-lg">Cards</h5>
                                <a href="@Url.Action("ShowAll", "Card")" class="text-indigo-600 text-sm">Show All</a>
                            </div>

                            @if (Model.Card != null)
                            {
                                var firstCard = Model.Card;
                                <div class="relative w-full h-48 rounded-xl shadow-lg text-white p-4" style="background: linear-gradient(135deg, #000000, #333);">
                                    <h6 class="font-bold text-lg">@firstCard.CardHolderName</h6>
                                    <p class="tracking-wider mt-4 text-lg">@firstCard.CardNumber</p>
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1158px-Mastercard-logo.svg.png" alt="Card Network Logo" class="absolute top-4 right-4 w-10">
                                    <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 py-1 px-2 rounded-lg text-sm">CVV</div>
                                </div>
                            }
                            else
                            {
                                <p>No cards available. <a href="@Url.Action("AddCard", "Card")" class="text-indigo-600">Add a card</a>.</p>
                            }

                            <div class="flex justify-between mt-6">
                                <a href="@Url.Action("AddCard", "Card")" class="bg-indigo-600 text-white rounded-full font-bold py-2 px-4 flex items-center">
                                    <span class="material-icons">add</span> Add Card
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="w-full lg:w-3/4 p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Welcome Message, Balance, Contacts, Transaction History -->
                        <div>
                            <div class="bg-green-100 text-green-800 p-4 rounded-lg mb-4">
                                Welcome back, @User.Identity.Name!
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-md mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="balance text-4xl font-bold text-gray-800">
                                        @ViewBag.SelectedWallet.Balance.ToString("C", System.Globalization.CultureInfo.CurrentCulture) @ViewBag.SelectedWallet.Currency
                                    </div>
                                    <form asp-action="Index" method="get">
                                        <select name="walletId" onchange="this.form.submit()" class="form-select border border-gray-300 rounded-lg">
                                            @foreach (var wallet in Model.Wallets)
                                            {
                                                <option value="@wallet.Id" selected="@(wallet.Id == ViewBag.SelectedWallet.Id ? "selected" : null)">
                                                    @wallet.Name (@wallet.Currency)
                                                </option>
                                            }
                                        </select>
                                    </form>
                                </div>

                                <!-- Transaction Action Buttons -->
                                <div class="mt-4 flex justify-center space-x-4">
                                    <!-- Deposit Button -->
                                    <a href="@Url.Action("SelectWalletAndCard", "Transaction", new { type = "Deposit" })" class="bg-green-500 text-white py-2 px-4 rounded-full font-bold">
                                        Deposit
                                    </a>

                                    <!-- Withdraw Button -->
                                    <a href="@Url.Action("SelectWalletAndCard", "Transaction", new { type = "Withdraw" })" class="bg-red-500 text-white py-2 px-4 rounded-full font-bold">
                                        Withdraw
                                    </a>

                                    <!-- Transfer Button -->
                                    <a href="@Url.Action("InitiateTransfer", "Transaction")" class="bg-blue-500 text-white py-2 px-4 rounded-full font-bold">
                                        Transfer
                                    </a>
                                </div>
                            </div>

                            <!-- Recent Contacts & Invite -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="bg-white rounded-xl p-6 shadow-md">
                                        <h5 class="font-bold text-lg mb-4">Recent Contacts</h5>
                                        <div class="flex flex-wrap" id="recentContacts">
                                            @await Html.PartialAsync("~/Views/Contacts/_RecentContacts.cshtml", Model.Contacts)
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="bg-white rounded-xl p-6 shadow-md text-center">
                                        <p>Invite a friend with code below and redeem a special bonus of USD 15 from us!</p>
                                        <div class="mt-4">
                                            <input type="text" class="form-input border border-gray-300 rounded-lg w-full" value="JELLYPOENYA-SEP2023" readonly>
                                            <button class="mt-2 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg">Copy</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction History -->
                            <div class="bg-white rounded-xl p-6 shadow-md mt-6">
                                <h5 class="font-bold text-lg mb-4">
                                    <a href="@Url.Action("TransactionHistory", "Transaction")" class="text-indigo-600">Transaction History</a>
                                </h5>
                                <div>
                                    @foreach (var transaction in Model.Transactions)
                                    {
                                        <div class="flex justify-between items-center py-3 border-b last:border-0">
                                            <div>
                                                <p class="font-semibold text-gray-700">@transaction.Description</p>
                                                <small class="text-gray-500">@transaction.Date.ToString("ddd, dd MMMM yyyy - h:mm tt")</small>
                                            </div>
                                            <div class="text-right">
                                                <p class="@(transaction.Direction == "Incoming" ? "text-green-500" : "text-red-500") font-bold">
                                                    @(transaction.Direction == "Incoming" ? "+" : "-")@transaction.Amount.ToString("C", System.Globalization.CultureInfo.CurrentCulture)
                                                </p>
                                            </div>
                                        </div>
                                    }
                                    <div class="text-center mt-4">
                                        <a href="@Url.Action("TransactionHistory", "Transaction")" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4">View All Transactions</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Wallet Statistics Section -->
                        <div>
                            <div class="bg-white rounded-xl p-6 shadow-md">
                                <div class="mb-6">
                                    <h5 class="font-bold text-lg">Wallet Statistics</h5>
                                    <p class="text-gray-600">Total spent this month: @Model.TotalSpentThisMonth.ToString("C")</p>
                                </div>

                                <!-- Bar Chart for Weekly Spending -->
                                <canvas id="weeklySpendingChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Logout Button -->
                    <div class="text-center mt-8">
                        <form asp-controller="Account" asp-action="Logout" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4">Log Out</button>
                        </form>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center mt-8">
                <h2 class="text-2xl font-bold mb-4">Please log in to access your dashboard.</h2>
                <a href="@Url.Action("Login", "Account")" class="bg-indigo-600 text-white rounded-full font-bold py-2 px-4">Log In</a>
                <a href="@Url.Action("Register", "Account")" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4 ml-2">Register</a>
            </div>
        }
    </div>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Data for the bar chart with weekly spending
        var weeklySpendingData = {
            labels: @Html.Raw(Json.Serialize(Model.WeeklySpendingLabels)), // Week labels
            datasets: [{
                label: 'Weekly Spending',
                data: @Html.Raw(Json.Serialize(Model.WeeklySpendingAmounts)), // Spending amounts
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        // Config for the chart
        var config = {
            type: 'bar', // Bar chart
            data: weeklySpendingData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Weekly Spending'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true // Ensure the y-axis starts at 0
                    }
                }
            },
        };

        // Render the chart
        var ctx = document.getElementById('weeklySpendingChart').getContext('2d');
        new Chart(ctx, config);
    </script>
</body>

</html>
