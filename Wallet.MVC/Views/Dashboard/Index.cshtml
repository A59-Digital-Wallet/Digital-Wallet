@model HomeViewModel
@{
    Layout = "_Layout";
}
@{
    ViewData["Title"] = "Home Page";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-gray-100 font-sans">

    <div class="container mx-auto mt-8">
        @if (User.Identity.IsAuthenticated)
        {
            <div class="flex flex-wrap">
                <!-- Sidebar -->
                <div class="w-full lg:w-1/4 p-4">
                    <div class="bg-white rounded-xl p-6 shadow-md">
                        <div class="text-center mb-6">
                            <img src="https://via.placeholder.com/150" alt="User Image" class="mx-auto rounded-full mb-3">
                            <h5 class="font-bold text-lg">@User.Identity.Name</h5>
                            <p class="text-gray-600">@User.Identity.Name's Dashboard</p>
                            <a class="text-indigo-600" href="@Url.Action("Profile", "User")">Profile</a>
                        </div>
                        <!-- Cards Section -->
                        <div class="mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-bold text-lg">Cards</h5>
                                <a href="@Url.Action("ShowAll", "Card")" class="text-indigo-600 text-sm">Show All</a>
                            </div>
                            @if (Model.Card != null)
                            {
                                var firstCard = Model.Card;
                                <div class="relative w-full h-48 rounded-xl shadow-lg text-white p-4" style="background: linear-gradient(135deg, #000000, #333);">
                                    <h6 class="font-bold text-lg">@firstCard.CardHolderName</h6>
                                    <p class="tracking-wider mt-4 text-lg">@firstCard.CardNumber</p>
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1158px-Mastercard-logo.svg.png" alt="Card Network Logo" class="absolute top-4 right-4 w-10">
                                    <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 py-1 px-2 rounded-lg text-sm">CVV</div>
                                </div>
                            }
                            else
                            {
                                <p>No cards available. <a href="@Url.Action("AddCard", "Card")" class="text-indigo-600">Add a card</a>.</p>
                            }
                            <div class="flex justify-between mt-6">
                                <a href="@Url.Action("AddCard", "Card")" class="bg-indigo-600 text-white rounded-full font-bold py-2 px-4 flex items-center">
                                    <span class="material-icons">add</span> Add Card
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="w-full lg:w-3/4 p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Welcome Message, Balance, Contacts, Transaction History -->
                        <div>
                            <div class="bg-green-100 text-green-800 p-4 rounded-lg mb-4">
                                Welcome back, @User.Identity.Name!
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-md mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="balance text-4xl font-bold text-gray-800">
                                        @ViewBag.SelectedWallet.Balance.ToString("C", System.Globalization.CultureInfo.GetCultureInfo(ViewBag.SelectedWallet.CurrencyCulture))
                                    </div>
                                    <form asp-action="Index" method="get" class="flex items-center space-x-4">
                                        <select name="walletId" onchange="this.form.submit()" class="form-select border border-gray-300 rounded-lg">
                                            @foreach (var wallet in Model.Wallets)
                                            {
                                                <option value="@wallet.Id" selected="@(wallet.Id == ViewBag.SelectedWallet.Id ? "selected" : null)">
                                                    @wallet.Name (@wallet.Currency)
                                                </option>
                                            }
                                        </select>
                                        @if (ViewBag.ShowManageMembersButton)
                                        {
                                            <a href="@Url.Action("ManageJointWalletMembers", "Wallet", new { walletId = ViewBag.SelectedWallet.Id })" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold">
                                                Manage Members
                                            </a>
                                        }
                                    </form>
                                </div>

                                <!-- Transaction Action Buttons -->
                                <div class="mt-4 flex justify-center space-x-4">
                                    <a href="@Url.Action("SelectWalletAndCard", "Transaction", new { type = "Deposit" })" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold">Deposit</a>
                                    <a href="@Url.Action("SelectWalletAndCard", "Transaction", new { type = "Withdraw" })" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold">Withdraw</a>
                                    <a href="@Url.Action("Create", "Wallet")" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold"> Create a Wallet</a>
                                </div>
                            </div>


                            <!-- Actions Card -->
                            <div class="bg-white rounded-xl p-6 shadow-md mb-6">
                                <h5 class="font-bold text-lg mb-4">Actions</h5>
                                <ul>
                                    @if (Model.ReceivedRequests != null && Model.ReceivedRequests.Any())
                                    {
                                        @foreach (var request in Model.ReceivedRequests)
                                        {
                                            <li class="border-b border-gray-200 py-2 flex justify-between items-center">
                                                <div>
                                                    <span class="font-semibold">@request.Description</span>
                                                    requested
                                                    <span class="font-semibold">@request.Amount @request.RequestedCurrency</span>
                                                </div>
                                                <div class="space-x-2">
                                                    <form asp-action="ApproveRequest" asp-controller="MoneyRequest" method="post" class="inline">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="requestId" value="@request.Id" />
                                                        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded-full">Approve</button>
                                                    </form>
                                                    <form asp-action="RejectRequest" asp-controller="MoneyRequest" method="post" class="inline">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="requestId" value="@request.Id" />
                                                        <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded-full">Reject</button>
                                                    </form>
                                                </div>
                                            </li>
                                        }
                                    }
                                    else
                                    {
                                        <li class="text-gray-500">No pending actions.</li>
                                    }
                                </ul>
                            </div>

                            <!-- Recent Contacts & Invite -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="bg-white rounded-xl p-6 shadow-md">
                                        <h5 class="font-bold text-lg mb-4">Recent Contacts</h5>
                                        <div class="flex flex-wrap" id="recentContacts">
                                            @await Html.PartialAsync("~/Views/Contacts/_RecentContacts.cshtml", Model.Contacts)
                                        </div>
                                    </div>
                                </div>

                                <!-- New Category Section placed here -->
                                <div>
                                    <div class="bg-white rounded-xl p-6 shadow-md flex flex-col justify-between min-h-full">
                                        <div>
                                            <h5 class="font-bold text-lg mb-4">Categories</h5>
                                            <ul class="list-disc list-inside">
                                                @foreach (var category in Model.Categories)
                                                {
                                                    <li class="text-indigo-600">
                                                        <a href="@Url.Action("CategoryTransactions", "Category", new { categoryId = category.Id })">@category.Name</a>
                                                    </li>
                                                }
                                                @if (!Model.Categories.Any())
                                                {
                                                    <li class="text-gray-500">No categories available.</li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="mt-4">
                                            <a href="@Url.Action("CreateCategory", "Category")" class="bg-green-500 text-white py-2 px-4 rounded-full font-bold">
                                                Add Category
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction History -->
                            <div class="bg-white rounded-xl p-6 shadow-md mt-6">
                                <h5 class="font-bold text-lg mb-4">
                                    <a href="@Url.Action("TransactionHistory", "Transaction")" class="text-indigo-600">Transaction History</a>
                                </h5>
                                <div>
                                    @foreach (var transaction in Model.Transactions)
                                    {
                                        <div class="flex justify-between items-center py-3 border-b last:border-0">
                                            <div>
                                                <p class="font-semibold text-gray-700">@transaction.Description</p>
                                                <small class="text-gray-500">@transaction.Date.ToString("ddd, dd MMMM yyyy - h:mm tt")</small>
                                            </div>
                                            <div class="text-right">
                                                <p class="@(transaction.Direction == "Incoming" ? "text-green-500" : "text-red-500") font-bold">
                                                    @(transaction.Direction == "Incoming" ? "+" : "-")
                                                    @if (transaction.Direction == "Incoming")
                                                    {
                                                        @transaction.Amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo(transaction.CurrencyCultureSent))
                                                    }
                                                    else
                                                    {
                                                        @transaction.OriginalAmount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo(transaction.CurrencyCulture))
                                                    }
                                                </p>
                                            </div>
                                        </div>
                                    }
                                    <div class="text-center mt-4">
                                        <a href="@Url.Action("TransactionHistory", "Transaction")" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4">View All Transactions</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Wallet Statistics Section -->
                        <div>
                           

                            @if (ViewBag.SelectedWallet.Type != "Joint")
                            {
                                <div class="bg-white rounded-xl p-6 shadow-md">
                                    <div class="mb-6">
                                        <h5 class="font-bold text-lg">Wallet Statistics</h5>
                                        <p class="text-gray-600">Total spent this month: @Model.TotalSpentThisMonth.ToString("C", System.Globalization.CultureInfo.GetCultureInfo(ViewBag.SelectedWallet.CurrencyCulture))</p>
                                    </div>
                                    <!-- Bar Chart for Weekly Spending -->
                                    <canvas id="weeklySpendingChart" width="400" height="200"></canvas>
                                </div>

                                <div class="bg-white rounded-xl p-6 shadow-md mt-6">
                                    <h5 class="font-bold text-lg mb-4">Monthly Spending by Category</h5>
                                    <canvas id="categorySpendingChart" width="400" height="200"></canvas>
                                </div>

                                <div class="w-full bg-white rounded-xl p-6 shadow-md mt-6">
                                    <h5 class="font-bold text-lg mb-4">Wallet Balance Over Time</h5>

                                    <!-- Time Interval Buttons -->
                                    <div class="flex justify-around mb-4">
                                        <button onclick="updateChart('daily')" class="bg-indigo-600 text-white rounded-full py-2 px-4 font-bold">Daily</button>
                                        <button onclick="updateChart('weekly')" class="bg-indigo-600 text-white rounded-full py-2 px-4 font-bold">Weekly</button>
                                        <button onclick="updateChart('monthly')" class="bg-indigo-600 text-white rounded-full py-2 px-4 font-bold">Monthly</button>
                                        <button onclick="updateChart('yearly')" class="bg-indigo-600 text-white rounded-full py-2 px-4 font-bold">Yearly</button>
                                    </div>

                                    <canvas id="balanceGrowthChart" width="400" height="200"></canvas>
                                </div>
                            }
                        </div>
                    </div>
                    


                    <!-- Logout Button -->
                    <div class="text-center mt-8">
                        <form asp-controller="Account" asp-action="Logout" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4">Log Out</button>
                        </form>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center mt-8">
                <h2 class="text-2xl font-bold mb-4">Please log in to access your dashboard.</h2>
                <a href="@Url.Action("Login", "Account")" class="bg-indigo-600 text-white rounded-full font-bold py-2 px-4">Log In</a>
                <a href="@Url.Action("Register", "Account")" class="border border-indigo-600 text-indigo-600 rounded-full font-bold py-2 px-4 ml-2">Register</a>
            </div>
        }
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        var weeklySpendingData = {
            labels: @Html.Raw(Json.Serialize(Model.WeeklySpendingLabels)),
            datasets: [{
                label: 'Weekly Spending',
                data: @Html.Raw(Json.Serialize(Model.WeeklySpendingAmounts)),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        var config = {
            type: 'bar',
            data: weeklySpendingData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Weekly Spending'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            },
        };

        var ctx = document.getElementById('weeklySpendingChart').getContext('2d');
        new Chart(ctx, config);
    </script>

    <script>
        var categorySpendingData = {
            labels: @Html.Raw(Json.Serialize(Model.MonthlySpendingByCategory.Keys)),
            datasets: [{
                label: 'Spending by Category',
                data: @Html.Raw(Json.Serialize(Model.MonthlySpendingByCategory.Values)),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ],
                hoverBackgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        };

        var config = {
            type: 'pie',
            data: categorySpendingData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Monthly Spending by Category'
                    }
                }
            },
        };

        var ctx = document.getElementById('categorySpendingChart').getContext('2d');
        new Chart(ctx, config);
    </script>
    <script>
        var balanceGrowthChart;

        $(document).ready(function () {
            console.log("Initializing chart...");

            // Check if labels and data are correctly passed to the view
            console.log("Labels:", @Html.Raw(Json.Serialize(Model.DailyBalanceLabels)));
            console.log("Data:", @Html.Raw(Json.Serialize(Model.DailyBalanceAmounts)));

            // Initialize the chart with default data
            var ctx = document.getElementById('balanceGrowthChart').getContext('2d');
            balanceGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.DailyBalanceLabels)),
                    datasets: [{
                        label: 'Wallet Balance',
                        data: @Html.Raw(Json.Serialize(Model.DailyBalanceAmounts)),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Wallet Balance Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        });

        function updateChart(interval) {
            console.log("Updating chart with interval:", interval);

            $.ajax({
                url: '@Url.Action("Index", "Dashboard")',
                type: 'GET',
                data: { interval: interval },
                success: function (result) {
                    console.log("AJAX call success, result:", result);

                    balanceGrowthChart.data.labels = result.balanceLabels;
                    balanceGrowthChart.data.datasets[0].data = result.balanceAmounts;
                    balanceGrowthChart.update();
                },
                error: function (xhr, status, error) {
                    console.error("AJAX call error:", error);
                }
            });
        }
        
    </script>

</body>

</html>
